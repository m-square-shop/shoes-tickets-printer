<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Product Label Generator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¶</text></svg>">
    
    <!-- CDN Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

    <style>
        /* CSS for immersive ticket editing experience */
        * {
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .header {
            color: #000;
            text-align: center;
            margin-bottom: 40px;
        }
        .header h1 {
            margin: 0;
            font-size: 36px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .header p {
            margin: 12px 0 0 0;
            color: #555;
            font-size: 16px;
        }
        .ticket-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.15);
            padding: 45px;
            width: fit-content; /* Fit content instead of responsive */
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .ticket-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.2);
        }
        .ticket-label {
            width: 450px; /* Fixed width matching PDF (45mm) */
            height: 450px; /* Fixed height matching PDF (45mm) */
            border: 3px solid #000;
            background: white;
            padding: 10px; /* Reduced from 15px */
            box-sizing: border-box;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* Changed from space-between for better control */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .ticket-product-name {
            font-weight: normal;
            font-size: 28px; /* Reduced from 32px */
            color: #000;
            text-align: center; /* Centered alignment */
            margin-bottom: 2px; /* Reduced spacing before QR code */
            padding: 4px 6px; /* Reduced from 6px 8px */
            border: 2px dashed transparent;
            border-radius: 6px;
            cursor: text;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: pre-line;
            line-height: 1.3;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .ticket-product-name:hover {
            border-color: #bbb;
            background: #f8f9fa;
        }
        .ticket-product-name:focus {
            border-color: #4a90e2;
            background: #f0f7ff;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        .ticket-company-name-static {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0;
            margin: 0;
            user-select: none;
            cursor: default;
        }
        .ticket-company-logo {
            height: 90px;
            width: auto;
            display: block;
        }
        .ticket-company-logo svg {
            height: 100%;
            width: auto;
            display: block;
        }
        .ticket-qrcode {
            width: 220px;
            height: 220px;
            display: flex;
            align-items: center;
            justify-content: center; /* Centered alignment */
            margin: 0 auto 8px auto; /* Increased spacing below QR code */
            flex-shrink: 0; /* Prevent shrinking */
        }
        #preview-qrcode-div {
            display: flex;
            justify-content: center; /* Centered alignment */
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .ticket-product-id-container {
            display: flex;
            justify-content: center; /* Centered alignment */
            align-items: center;
            margin: 0 auto 5px auto; /* Centered, spacing below */
            flex-shrink: 0; /* Prevent shrinking */
        }
        .ticket-product-id-input {
            font-family: Arial, sans-serif;
            font-size: 24px;
            font-weight: normal;
            color: #000;
            background: transparent;
            border: 2px dashed transparent;
            border-radius: 6px;
            padding: 4px 8px; /* Reduced from 6px 12px */
            text-align: center; /* Centered alignment */
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 150px;
            max-width: 350px;
        }
        .ticket-product-id-input:hover {
            border-color: #bbb;
            background: #f8f9fa;
        }
        .ticket-product-id-input:focus {
            border-color: #4a90e2;
            background: #f0f7ff;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        .ticket-product-id {
            font-size: 11px;
            font-weight: normal;
            text-align: center;
            color: #000;
            margin-bottom: 15px;
            padding: 4px;
            border: 2px dashed transparent;
            border-radius: 4px;
            cursor: text;
            outline: none;
            transition: all 0.2s;
        }
        .ticket-product-id:hover {
            border-color: #999;
            background: #f5f5f5;
        }
        .ticket-product-id:focus {
            border-color: #666;
            background: #f5f5f5;
        }
        .ticket-bottom-section {
            display: flex;
            justify-content: flex-end; /* Align to right since logo is removed */
            align-items: flex-end;
            margin-top: auto; /* Push to bottom */
            gap: 0;
            min-width: 0;
            overflow: hidden; /* Prevent overflow */
            width: 100%; /* Ensure full width */
            flex-shrink: 0; /* Prevent shrinking */
            padding-top: 2px; /* Reduced from 4px */
        }
        .ticket-label-left {
            display: none !important; /* Logo is now only inside QR code, completely hide */
        }
        .ticket-price-right {
            flex: 0 0 auto; /* Don't shrink - maintain size */
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-end;
            gap: 0px; /* No gap - prices are very close */
            min-width: 0; /* Allow shrinking */
            max-width: calc(100% - 10px); /* Prevent overflow, leave some margin */
            overflow: hidden; /* Prevent overflow */
            padding-right: 5px; /* Add small padding from right edge */
        }
        .ticket-old-price-wrapper,
        .ticket-current-price-wrapper {
            display: flex;
            align-items: baseline;
            justify-content: flex-end;
            gap: 4px;
            min-width: 0; /* Allow shrinking */
            max-width: 100%; /* Prevent overflow */
            overflow: hidden; /* Prevent overflow */
        }
        .ticket-old-price-wrapper.hidden {
            display: none !important;
        }
        .ticket-old-price,
        .ticket-current-price {
            font-family: Arial, sans-serif;
            background: transparent;
            border: 2px dashed transparent;
            border-radius: 6px;
            padding: 2px 6px;
            margin: 0;
            outline: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: right;
            white-space: nowrap;
            min-width: 60px;
            max-width: 100%; /* Allow to use available space */
            overflow: hidden; /* Prevent text overflow */
        }
        .ticket-old-price {
            font-size: 26px;
            font-weight: normal;
            color: #000;
            text-decoration: line-through;
            text-decoration-thickness: 3px;
        }
        .ticket-current-price {
            font-size: 42px; /* Reduced from 52px to fit smaller container */
            font-weight: bold;
            color: #000;
            line-height: 1;
        }
        .ticket-old-price:hover,
        .ticket-current-price:hover {
            border-color: #bbb;
            background: #f8f9fa;
            transform: scale(1.02);
        }
        .ticket-old-price:focus,
        .ticket-current-price:focus {
            border-color: #4a90e2;
            background: #f0f7ff;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }
        .ticket-currency {
            font-size: inherit;
            font-weight: inherit;
            color: #000;
            white-space: nowrap;
            user-select: none;
            margin-left: 4px;
            letter-spacing: 0.5px;
            opacity: 0.9;
        }
        .ticket-old-price-wrapper .ticket-currency {
            font-size: 26px;
            text-decoration: line-through;
            text-decoration-thickness: 3px;
        }
        .ticket-current-price-wrapper .ticket-currency {
            font-size: 42px; /* Reduced from 52px to match price */
            font-weight: bold;
        }
        .ticket-discount {
            font-weight: bold;
            font-size: 14px;
            color: #000;
            padding: 2px 4px;
            border: 2px dashed transparent;
            border-radius: 4px;
            cursor: text;
            outline: none;
            transition: all 0.2s;
            min-width: 100px;
            text-align: right;
        }
        .ticket-discount:hover {
            border-color: #999;
            background: #f5f5f5;
        }
        .ticket-discount:focus {
            border-color: #666;
            background: #f5f5f5;
        }
        .print-button-container {
            margin-top: 40px;
            text-align: center;
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        .print-button, .download-button {
            padding: 18px 45px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
            max-width: 280px;
            position: relative;
            overflow: hidden;
        }
        .print-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .print-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }
        .print-button:active {
            transform: translateY(-1px);
        }
        .download-button {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
        }
        .download-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(17, 153, 142, 0.5);
        }
        .download-button:active {
            transform: translateY(-1px);
        }
        .hidden {
            display: none !important;
        }

        /* Hidden area used for generating the images before placing them in the PDF */
        #code-staging {
            position: absolute;
            left: -9999px;
            top: -9999px;
        }
        #code-staging canvas {
            display: block;
        }
    </style>
</head>
<body>

    <div class="header">
        <h1>üì¶ Product Ticket Printer</h1>
        <p>Edit your ticket below, then click Print</p>
    </div>

    <div class="ticket-container">
        <div class="ticket-label" id="ticket-label">
            <!-- Product Name centered at top -->
            <div class="ticket-product-name" 
                 contenteditable="true" 
                 id="ticket-product-name"
                 data-placeholder="Product Name">PUMA BMW MMS LGND  Renegade</div>
            
            <!-- QR Code under product name, centered -->
            <div class="ticket-qrcode">
                <div id="preview-qrcode-div"></div>
            </div>
            
            <!-- Product ID under QR code, centered -->
            <div class="ticket-product-id-container">
                <input type="text" 
                       class="ticket-product-id-input" 
                       id="ticket-product-id-input"
                       placeholder="Product ID"
                       value="PUMA_FerrariRSBlack">
            </div>
            
            <!-- Bottom Section: Price (right) -->
            <div class="ticket-bottom-section">
                <!-- Logo is now inside QR code, removed from bottom left -->
                <div class="ticket-label-left">
                    <div class="ticket-company-name-static" 
                         id="ticket-company-name">
                        <div class="ticket-company-logo">
                            <svg width="1327" height="1327" viewBox="0 0 1327 1327" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M1100.72 227H226V351.961H975.763V976.764H791.447L707.098 1101.73H1100.72V227Z" fill="black"/>
                                <path d="M675.86 501.914H813.316L519.659 961.145L350.962 708.099L350.962 1101.73H226.001V501.914H363.456L519.659 748.712L675.86 501.914Z" fill="black"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="ticket-price-right">
                    <div class="ticket-old-price-wrapper" id="ticket-old-price-wrapper">
                        <input type="text" 
                               class="ticket-old-price" 
                               id="ticket-old-price"
                               placeholder="Old Price"
                               value="21500"
                               inputmode="numeric">
                        <span class="ticket-currency">DZD</span>
                    </div>
                    <div class="ticket-current-price-wrapper">
                        <input type="text" 
                               class="ticket-current-price" 
                               id="ticket-current-price"
                               placeholder="Price"
                               value="18950"
                               inputmode="numeric">
                        <span class="ticket-currency">DZD</span>
                    </div>
                </div>
            </div>
            
            <!-- Hidden Product ID for QR code generation -->
            <div class="ticket-product-id hidden" 
                 contenteditable="true" 
                 id="ticket-product-id"
                 data-placeholder="Product ID">ID: PUMA_FerrariRSBlack</div>
        </div>

        <div class="print-button-container">
            <button class="print-button" onclick="printTicket()">üñ®Ô∏è Print Directly</button>
            <button class="download-button" onclick="downloadTicket()">üíæ Download PDF</button>
        </div>
    </div>

    <!-- Hidden inputs for calculations -->
    <input type="hidden" id="product-name" value="PUMA BMW MMS LGND  Renegade">
    <input type="hidden" id="product-id" value="PUMA_FerrariRSBlack">
    <input type="hidden" id="old-price" value="21500">
    <input type="hidden" id="current-price" value="18950">

    <div id="code-staging">
        <div id="qrcode-div"></div>
    </div>
    

    <script>
        // Wait for DOM and libraries to be ready
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for CDN libraries to load
            setTimeout(function() {
                if (typeof window.jspdf === 'undefined') {
                    alert('Error: jsPDF library failed to load from CDN. Please check your internet connection.');
                    return;
                }
                
                if (typeof QRCode === 'undefined') {
                    alert('Error: QRCode library failed to load from CDN. Please check your internet connection.');
                    return;
                }
                
                // Initialize application
                initApp();
            }, 100);
        });
        
        function initApp() {
            // Use window.jsPDF to access the library loaded via CDN
            const { jsPDF } = window.jspdf;

            // --- Helper function to convert SVG to Canvas/Image ---
            // Optimized: Calculate canvas size based on final PDF output size
            function svgToCanvas(svgElement, targetHeightMM = 10) {
            return new Promise((resolve) => {
                const svgData = new XMLSerializer().serializeToString(svgElement);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                // Get dimensions from SVG element or use viewBox
                const svgWidth = svgElement.width?.baseVal?.value || svgElement.viewBox?.baseVal?.width || 1327;
                const svgHeight = svgElement.height?.baseVal?.value || svgElement.viewBox?.baseVal?.height || 1327;
                
                // Calculate optimal canvas size based on PDF output
                // PDF is 55mm wide, logo will be ~10mm tall
                // At 300 DPI (print quality): 10mm = ~118 pixels
                // Use 2x for retina/quality: ~236 pixels
                // But keep it reasonable: max 400px for performance
                const DPI = 300;
                const MM_TO_INCH = 25.4;
                const targetHeightPx = Math.min((targetHeightMM / MM_TO_INCH) * DPI * 2, 400);
                const aspectRatio = svgWidth / svgHeight;
                const targetWidthPx = targetHeightPx * aspectRatio;
                
                canvas.width = Math.round(targetWidthPx);
                canvas.height = Math.round(targetHeightPx);
                
                img.onload = function() {
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/png'));
                };
                
                img.onerror = function() {
                    console.error('Error loading SVG image');
                    resolve(null);
                };
                
                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
            });
        }

            // --- Helper function to format number with thousands separators ---
            function formatNumber(num) {
                if (!num && num !== 0) return '';
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }

            // --- Helper function to extract number from text ---
            function extractNumber(text) {
                const match = text.match(/[\d,]+\.?\d*/);
                return match ? parseFloat(match[0].replace(/,/g, '')) : 0;
            }

            // --- Helper function to extract ID from text ---
            function extractID(text) {
                const match = text.match(/ID:\s*(\d+)/i) || text.match(/(\d{8,})/);
                return match ? match[1] : '';
            }

            // --- Event Listeners and Calculations ---
            const companyNameEl = document.getElementById('ticket-company-name'); // Now static, uneditable
            const productNameEl = document.getElementById('ticket-product-name'); // Now at top
            const productIdEl = document.getElementById('ticket-product-id');
            const currentPriceEl = document.getElementById('ticket-current-price');
            const oldPriceEl = document.getElementById('ticket-old-price');

            // Handle product name changes (now at top)
            if (productNameEl) {
                productNameEl.addEventListener('input', () => {
                    const name = productNameEl.textContent.trim();
                    document.getElementById('product-name').value = name;
                    updatePreview();
                });
            }

            // Handle product ID changes
            if (productIdEl) {
                productIdEl.addEventListener('input', () => {
                    const id = extractID(productIdEl.textContent);
                    document.getElementById('product-id').value = id;
                    updatePreview();
                });
            }

            // Handle current price changes - only allow numbers, format on blur
            if (currentPriceEl) {
                // On focus, show plain number for editing
                currentPriceEl.addEventListener('focus', (e) => {
                    const value = e.target.value.replace(/[^\d]/g, '');
                    e.target.value = value;
                });
                
                // On input, filter to only allow digits
                currentPriceEl.addEventListener('input', (e) => {
                    const value = e.target.value.replace(/[^\d]/g, ''); // Remove all non-digits
                    e.target.value = value;
                    const price = parseFloat(value) || 0;
                    document.getElementById('current-price').value = price;
                    updateDiscount();
                    updatePreview();
                });
                
                // On blur, format with thousands separators
                currentPriceEl.addEventListener('blur', (e) => {
                    const value = e.target.value.replace(/[^\d]/g, '');
                    const price = parseFloat(value) || 0;
                    if (price > 0) {
                        e.target.value = formatNumber(price);
                    }
                    document.getElementById('current-price').value = price;
                    updateDiscount();
                    updatePreview();
                });
            }

            // Handle old price changes - only allow numbers, format on blur
            if (oldPriceEl) {
                // On focus, show plain number for editing
                oldPriceEl.addEventListener('focus', (e) => {
                    const value = e.target.value.replace(/[^\d]/g, '');
                    e.target.value = value;
                });
                
                // On input, filter to only allow digits
                oldPriceEl.addEventListener('input', (e) => {
                    const value = e.target.value.replace(/[^\d]/g, ''); // Remove all non-digits
                    e.target.value = value;
                    const price = parseFloat(value) || 0;
                    document.getElementById('old-price').value = price;
                    updateDiscount();
                    updatePreview();
                });
                
                // On blur, format with thousands separators
                oldPriceEl.addEventListener('blur', (e) => {
                    const value = e.target.value.replace(/[^\d]/g, '');
                    const price = parseFloat(value) || 0;
                    if (price > 0) {
                        e.target.value = formatNumber(price);
                    }
                    document.getElementById('old-price').value = price;
                    updateDiscount();
                    updatePreview();
                });
            }

            // Handle product ID input changes - allow text, numbers, and special characters
            const productIdInputEl = document.getElementById('ticket-product-id-input');
            if (productIdInputEl) {
                // Initialize hidden input and QR code
                const id = productIdInputEl.value.trim();
                document.getElementById('product-id').value = id;
                
                // Add event listener for input changes
                productIdInputEl.addEventListener('input', (e) => {
                    const id = e.target.value.trim();
                    // Update hidden input for compatibility
                    document.getElementById('product-id').value = id;
                    // Update QR code immediately
                    updateQRCode(id);
                });
                
                // Generate initial QR code
                updateQRCode(id);
            }

            // Prevent line breaks in contenteditable fields (product name allows multi-line)
            // Company name is now static, product ID is an input field

            // Initialize hidden inputs from visible inputs and format prices
            if (currentPriceEl) {
                const currentPrice = parseFloat(currentPriceEl.value.replace(/[^\d]/g, '')) || 0;
                document.getElementById('current-price').value = currentPrice;
                if (currentPrice > 0) {
                    currentPriceEl.value = formatNumber(currentPrice);
                }
            }
            if (oldPriceEl) {
                const oldPrice = parseFloat(oldPriceEl.value.replace(/[^\d]/g, '')) || 0;
                document.getElementById('old-price').value = oldPrice;
                if (oldPrice > 0) {
                    oldPriceEl.value = formatNumber(oldPrice);
                }
            }
            
            // Initial update
            updateDiscount();
            updatePreview();
            
            // --- Helper Functions ---
            
            function updateDiscount() {
                // Old price input is always visible in HTML (with placeholder)
                // PDF generation will handle showing/hiding based on value
                // This function kept for potential future use
            }

            // Helper function to add logo to QR code canvas
            function addLogoToQRCode(qrCanvas, logoDataUrl, logoSizePercent = 30) {
                return new Promise((resolve) => {
                    if (!logoDataUrl) {
                        resolve(qrCanvas.toDataURL('image/png'));
                        return;
                    }
                    
                    const logoImg = new Image();
                    logoImg.onload = function() {
                        const ctx = qrCanvas.getContext('2d');
                        const qrSize = qrCanvas.width;
                        const logoSize = Math.floor(qrSize * (logoSizePercent / 100));
                        const logoX = (qrSize - logoSize) / 2;
                        const logoY = (qrSize - logoSize) / 2;
                        
                        // Draw white background for logo area (to ensure QR code readability)
                        // Use smaller padding to preserve more QR code data
                        ctx.fillStyle = '#ffffff';
                        const padding = logoSize * 0.12; // 12% padding around logo
                        ctx.fillRect(logoX - padding, logoY - padding, logoSize + (padding * 2), logoSize + (padding * 2));
                        
                        // Draw logo centered
                        ctx.drawImage(logoImg, logoX, logoY, logoSize, logoSize);
                        
                        resolve(qrCanvas.toDataURL('image/png'));
                    };
                    logoImg.onerror = function() {
                        resolve(qrCanvas.toDataURL('image/png'));
                    };
                    logoImg.src = logoDataUrl;
                });
            }

            // Function to update QR code (HTML preview - no logo)
            function updateQRCode(id) {
                const qrcodeDiv = document.getElementById('preview-qrcode-div');
                if (qrcodeDiv) {
                    qrcodeDiv.innerHTML = '';
                    if (id && id.trim()) {
                        // Generate QR code without logo for HTML preview
                        new QRCode(qrcodeDiv, {
                            text: id.trim(),
                            width: 220,
                            height: 220,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                    }
                }
            }

            function updatePreview() {
                const name = document.getElementById('product-name')?.value || '';
                const oldPrice = parseFloat(document.getElementById('old-price')?.value) || 0;
                const currentPrice = parseFloat(document.getElementById('current-price')?.value) || 0;

                // Update product name if empty
                const productNameEl = document.getElementById('ticket-product-name');
                if (productNameEl) {
                    if (!name && productNameEl.textContent.trim() === '') {
                        productNameEl.textContent = 'Product Name';
                    }
                }

                // Price inputs handle their own values - DZD is persistent in UI
                // No need to update price displays here

                // Update QR code from product ID input
                const productIdInput = document.getElementById('ticket-product-id-input');
                if (productIdInput) {
                    const id = productIdInput.value.trim();
                    document.getElementById('product-id').value = id;
                    updateQRCode(id);
                }
            }

            // --- PDF Generation Logic ---

            async function generatePDF() {
                const companyNameEl = document.getElementById('ticket-company-name');
                const productNameEl = document.getElementById('ticket-product-name');
                const productIdInputEl = document.getElementById('ticket-product-id-input');
                const oldPriceEl = document.getElementById('ticket-old-price');
                const currentPriceEl = document.getElementById('ticket-current-price');

                if (!companyNameEl || !productNameEl || !productIdInputEl || !currentPriceEl) {
                    alert("Error: Some required elements are missing.");
                    return null;
                }

                // Get SVG logo from company name element
                const companyLogoSvg = companyNameEl.querySelector('svg');
                
                // Preserve line breaks from <br> tags - convert <br> to newlines
                const nameHTML = productNameEl.innerHTML;
                const name = nameHTML.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]*>/g, '').trim();
                // Get product ID from input field (can contain text, numbers, and special chars)
                const id = productIdInputEl.value.trim();
                // Get prices from input elements (remove formatting commas)
                const oldPrice = oldPriceEl ? parseFloat(oldPriceEl.value.replace(/[^\d]/g, '')) || 0 : 0;
                const currentPrice = parseFloat(currentPriceEl.value.replace(/[^\d]/g, '')) || 0;
                // Only show old price in PDF if it has a value and is greater than current price
                const showOldPrice = oldPrice > currentPrice && oldPrice > 0;
                
                // Calculate discount
                let discountPercent = 0;
                if (oldPrice > currentPrice && oldPrice > 0) {
                    discountPercent = ((oldPrice - currentPrice) / oldPrice) * 100;
                }
                
                if (!id || !name || name === 'Product Name') {
                    alert("Please fill in Product Name and Product ID.");
                    return null;
                }

                // --- 1. Get SVG Logo for QR code (logo is now only inside QR code, not displayed separately) ---
                // Logo will be embedded in QR code, no separate logo image needed

                // --- 2. Generate QR Code with Logo ---
                // Helper function to generate QR code with logo
                async function generateQRCodeWithLogo(text, size, logoSvg) {
                    return new Promise((resolve) => {
                        // Create temporary container for QR code
                        const tempDiv = document.createElement('div');
                        tempDiv.style.position = 'absolute';
                        tempDiv.style.left = '-9999px';
                        tempDiv.style.top = '-9999px';
                        document.body.appendChild(tempDiv);
                        
                        // Generate QR code
                        new QRCode(tempDiv, {
                            text: text,
                            width: size,
                            height: size,
                            colorDark: "#000000",
                            colorLight: "#ffffff",
                            correctLevel: QRCode.CorrectLevel.H
                        });
                        
                        // Wait for QR code to render using polling approach
                        let attempts = 0;
                        const maxAttempts = 30; // Max 1.5 seconds
                        
                        const checkAndAddLogo = async () => {
                            attempts++;
                            const qrCanvas = tempDiv.querySelector('canvas');
                            
                            if (!qrCanvas || qrCanvas.width === 0 || qrCanvas.height === 0) {
                                if (attempts < maxAttempts) {
                                    setTimeout(checkAndAddLogo, 50);
                                } else {
                                    // Canvas not ready, return QR code without logo
                                    if (qrCanvas) {
                                        const dataUrl = qrCanvas.toDataURL('image/png');
                                        document.body.removeChild(tempDiv);
                                        resolve(dataUrl);
                                    } else {
                                        document.body.removeChild(tempDiv);
                                        resolve(null);
                                    }
                                }
                                return;
                            }
                            
                            // Canvas is ready
                            if (logoSvg) {
                                try {
                                    // Convert logo SVG to data URL (30% of QR code size)
                                    const logoDataUrl = await svgToCanvas(logoSvg, size * 0.30 / (25.4 / 96));
                                    
                                    if (!logoDataUrl) {
                                        // If logo conversion fails, return QR code without logo
                                        const dataUrl = qrCanvas.toDataURL('image/png');
                                        document.body.removeChild(tempDiv);
                                        resolve(dataUrl);
                                        return;
                                    }
                                    
                                    // Add logo directly to canvas
                                    const logoImg = new Image();
                                    logoImg.onload = function() {
                                        const ctx = qrCanvas.getContext('2d');
                                        const qrSize = qrCanvas.width;
                                        const logoSize = Math.floor(qrSize * 0.30); // 30% of QR code size
                                        const logoX = (qrSize - logoSize) / 2;
                                        const logoY = (qrSize - logoSize) / 2;
                                        
                                        // Draw white background for logo area
                                        ctx.fillStyle = '#ffffff';
                                        const padding = logoSize * 0.12; // 12% padding
                                        ctx.fillRect(logoX - padding, logoY - padding, logoSize + (padding * 2), logoSize + (padding * 2));
                                        
                                        // Draw logo centered
                                        ctx.drawImage(logoImg, logoX, logoY, logoSize, logoSize);
                                        
                                        // Get final image data URL
                                        const finalDataUrl = qrCanvas.toDataURL('image/png');
                                        document.body.removeChild(tempDiv);
                                        resolve(finalDataUrl);
                                    };
                                    logoImg.onerror = function() {
                                        // If logo fails to load, return QR code without logo
                                        const dataUrl = qrCanvas.toDataURL('image/png');
                                        document.body.removeChild(tempDiv);
                                        resolve(dataUrl);
                                    };
                                    logoImg.src = logoDataUrl;
                                } catch (error) {
                                    console.error('Error adding logo to QR code:', error);
                                    const dataUrl = qrCanvas.toDataURL('image/png');
                                    document.body.removeChild(tempDiv);
                                    resolve(dataUrl);
                                }
                            } else {
                                // No logo SVG, return QR code without logo
                                const dataUrl = qrCanvas.toDataURL('image/png');
                                document.body.removeChild(tempDiv);
                                resolve(dataUrl);
                            }
                        };
                        
                        // Start checking after initial delay
                        setTimeout(checkAndAddLogo, 100);
                    });
                }
                
                // Always generate QR code with logo for PDF (HTML preview doesn't have logo)
                let qrcodeDataUrl = null;
                
                if (companyLogoSvg) {
                    // Generate QR code with logo
                    qrcodeDataUrl = await generateQRCodeWithLogo(id, 200, companyLogoSvg);
                } else {
                    // Fallback: Generate QR code without logo if SVG not found
                    alert("Warning: Logo SVG not found. Generating QR code without logo.");
                    qrcodeDataUrl = await generateQRCodeWithLogo(id, 200, null);
                }
                
                if (!qrcodeDataUrl) {
                    alert("Error: Failed to generate QR code.");
                    return null;
                }

                // --- 2. Initialize jsPDF ---
                // Page size: 45mm width x 45mm height (custom ticket printer size, portrait direction)
                const LABEL_WIDTH_MM = 45;  // Width
                const LABEL_HEIGHT_MM = 45; // Height

                // jsPDF format array: [width, height]
                // For square format (45mm x 45mm), we use format: [45, 45]
                // Explicitly set orientation to 'portrait' to ensure correct orientation
                const doc = new jsPDF({
                    unit: 'mm',
                    format: [LABEL_WIDTH_MM, LABEL_HEIGHT_MM],
                    orientation: 'portrait',
                    compress: true
                });
                
                // Verify dimensions are correct
                const actualWidth = doc.internal.pageSize.getWidth();
                const actualHeight = doc.internal.pageSize.getHeight();
                console.log('PDF Dimensions - Requested: 45mm(width) x 45mm(height), Actual:', actualWidth + 'mm x ' + actualHeight + 'mm');
                
                // If dimensions are still wrong, the format array interpretation is different
                // In that case, we need to use the direct format: [55, 45] and accept jsPDF's behavior
                // OR manually fix by recreating with different approach

                // Set all colors to black for black and white printing
                doc.setTextColor(0, 0, 0);
                doc.setDrawColor(0, 0, 0);

                // --- 3. Calculate exact scaling to match HTML styling ---
                // HTML ticket-label: max-width 900px (ticket-container), padding 15px, border 3px
                // PDF: 45mm √ó 45mm (custom ticket printer size)
                // To match visual appearance, we need to scale proportionally
                
                // Standard conversions:
                // 1 inch = 25.4mm = 72pt = 96px
                // So: 1px = 0.2646mm = 0.75pt
                
                // Scale factor: PDF width (45mm) relative to HTML container (900px)
                // Assuming HTML renders at ~96 DPI: 900px ‚âà 238mm
                // But for visual matching, we'll use direct proportional scaling
                const HTML_CONTAINER_WIDTH_PX = 900;
                const SCALE_RATIO = LABEL_WIDTH_MM / HTML_CONTAINER_WIDTH_PX;
                
                // Font sizes: Match HTML exactly - maintain same visual proportions
                // HTML: company 24px, product 20px, old price 26px, price 52px
                // Using calibrated sizes that match visual appearance on 45mm x 45mm label:
                // Company: 24px ‚Üí increased, use 8.4pt
                // Product: 20px ‚Üí increased to match company size, use 7pt
                // Old Price: 26px ‚Üí increased for better visibility, use 9.1pt
                // Price: 52px ‚Üí very large, increased to 22pt for better prominence
                const COMPANY_FONT_SIZE_PT = 8.4; // Matches visual size of 24px bold (increased)
                const PRODUCT_FONT_SIZE_PT = 7; // Matches visual size of 20px (same as company)
                const OLD_PRICE_FONT_SIZE_PT = 9.1; // Increased from 7.7pt to match 26px
                const PRICE_FONT_SIZE_PT = 22; // Matches visual size of 52px bold (increased for prominence)

                // Padding and spacing (HTML: 10px padding, border 3px) - reduced for better space usage
                // Scale proportionally: 10px * scale_ratio * mm_per_px
                const PADDING_MM = 10 * SCALE_RATIO * (25.4 / 96); // ‚âà 2.3mm (reduced from 3.5mm)
                const BORDER_WIDTH_MM = 3 * SCALE_RATIO * (25.4 / 96); // ‚âà 0.7mm
                
                // QR Code size (HTML: 120px √ó 120px)
                // Make it larger to match visual appearance - HTML QR code is quite prominent
                // Using a larger size that matches the visual proportion better
                const QR_SIZE_MM = 18; // Matches visual size of 120px QR code (larger for better visibility)

                // --- 4. Add border to match HTML (3px solid black) ---
                doc.setLineWidth(BORDER_WIDTH_MM);
                doc.rect(PADDING_MM, PADDING_MM, LABEL_WIDTH_MM - (PADDING_MM * 2), LABEL_HEIGHT_MM - (PADDING_MM * 2));

                // --- 5. Add Content to PDF (Matching HTML Layout Exactly) ---
                
                // Content area (inside padding and border)
                const CONTENT_X = PADDING_MM + BORDER_WIDTH_MM;
                const CONTENT_Y = PADDING_MM + BORDER_WIDTH_MM;
                const CONTENT_WIDTH = LABEL_WIDTH_MM - (PADDING_MM * 2) - (BORDER_WIDTH_MM * 2);
                const CONTENT_HEIGHT = LABEL_HEIGHT_MM - (PADDING_MM * 2) - (BORDER_WIDTH_MM * 2);
                
                // Calculate spacing to match HTML layout exactly
                // Layout: Top center: product name, under it: QR code, under it: product ID, bottom right: prices
                
                let yPos = CONTENT_Y + 2; // Reduced from 3.5mm - start after top padding/border
                
                // Product Name (centered at top, matching HTML: 28px normal, centered)
                doc.setFont('helvetica', 'normal'); // Arial equivalent (helvetica is closest to Arial)
                const PRODUCT_NAME_FONT_SIZE_PT = 8.6; // Matches visual size of 28px (reduced from 9.8pt)
                doc.setFontSize(PRODUCT_NAME_FONT_SIZE_PT);
                const nameParts = name.split('\n');
                const nameLines = doc.splitTextToSize(name, CONTENT_WIDTH - 4);
                const productNameTextY = yPos + (PRODUCT_NAME_FONT_SIZE_PT * 0.35);
                doc.text(nameLines, CONTENT_X + (CONTENT_WIDTH / 2), productNameTextY, { align: 'center', maxWidth: CONTENT_WIDTH - 4 });
                yPos = productNameTextY + (PRODUCT_NAME_FONT_SIZE_PT * 0.35 * nameLines.length) + 0.8; // Reduced spacing after product name (was 1.5)
                
                // QR Code (centered, under product name)
                const qrX = CONTENT_X + (CONTENT_WIDTH - QR_SIZE_MM) / 2; // Centered
                doc.addImage(qrcodeDataUrl, 'PNG', qrX, yPos, QR_SIZE_MM, QR_SIZE_MM);
                yPos += QR_SIZE_MM + 3; // Increased spacing after QR code (was 2mm)
                
                // Product ID text (centered, under QR code)
                if (id && id.trim()) {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(6.3); // Matches visual size of 24px
                    doc.text(id.trim(), CONTENT_X + (CONTENT_WIDTH / 2), yPos, { align: 'center' });
                    yPos += 3.5; // Reduced from 5mm - space after product ID
                }
                
                // Bottom section: Price (right) - Logo is now only inside QR code
                // Match HTML layout with flexbox justify-content: space-between, align-items: flex-end
                // HTML uses margin-top: auto to push content to bottom
                const bottomMargin = 1; // Reduced from 2mm - small margin from bottom edge
                const bottomY = CONTENT_Y + CONTENT_HEIGHT - bottomMargin;
                
                // Current Price (right, matching HTML: 52px bold, right-aligned, line-height: 1)
                const priceX = CONTENT_X + CONTENT_WIDTH - 2;
                doc.setFont('helvetica', 'bold'); // Arial equivalent
                doc.setFontSize(PRICE_FONT_SIZE_PT);
                const priceText = currentPrice > 0 ? `${formatNumber(Math.round(currentPrice))} DZD` : '';
                if (priceText) {
                    doc.text(priceText, priceX, bottomY, { align: 'right' });
                }
                
                // Old Price with strikethrough (if visible, positioned above current price, right-aligned)
                if (showOldPrice && oldPrice > 0) {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(OLD_PRICE_FONT_SIZE_PT);
                    const oldPriceText = `${formatNumber(Math.round(oldPrice))} DZD`;
                    // Position old price above current price - very close together
                    // Position it just above the current price with minimal gap
                    const oldPriceY = bottomY - (PRICE_FONT_SIZE_PT * 0.25) - (OLD_PRICE_FONT_SIZE_PT * 0.15);
                    
                    // Get text width before drawing text
                    const textWidth = doc.getTextWidth(oldPriceText);
                    
                    // Draw the text first
                    doc.text(oldPriceText, priceX, oldPriceY, { align: 'right' });
                    
                    // Draw strikethrough line - thin but visible
                    // Calculate the start and end positions for right-aligned text
                    const strikeStartX = priceX - textWidth - 0.3; // Start slightly before text
                    const strikeEndX = priceX + 0.3; // End slightly after text (right edge)
                    // Position strikethrough at the center of the text height
                    // oldPriceY is the baseline, so we move up by approximately half the font size to center it
                    const strikeY = oldPriceY - (OLD_PRICE_FONT_SIZE_PT * 0.14); // Centered in text
                    
                    doc.setLineWidth(0.3); // Thin line that doesn't obscure the text
                    doc.setDrawColor(0, 0, 0); // Ensure black color
                    doc.line(strikeStartX, strikeY, strikeEndX, strikeY);
                }

                return doc;
            }

            async function printTicket() {
                const doc = await generatePDF();
                if (!doc) return;
                
                // Open PDF in new window and trigger print dialog
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                const printWindow = window.open(pdfUrl);
                
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        // Clean up the URL after a delay
                        setTimeout(() => URL.revokeObjectURL(pdfUrl), 1000);
                    }, 250);
                };
            }

            async function downloadTicket() {
                const doc = await generatePDF();
                if (!doc) return;
                
                const name = document.getElementById('ticket-product-name').textContent.trim();
                doc.save(`${name.replace(/[^a-z0-9]/gi, '_')}_ticket.pdf`);
            }
            
            // Make functions globally accessible for onclick handlers
            window.printTicket = printTicket;
            window.downloadTicket = downloadTicket;
        } // End of initApp function

    </script>
</body>
</html>